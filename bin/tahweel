#!/usr/bin/env ruby

# frozen_string_literal: true

# Add the ../lib directory to the load path so we can require 'tahweel'
$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "tahweel"
require "tahweel/cli/progress_renderer"

begin
  soft, hard = Process.getrlimit(:NOFILE)
  Process.setrlimit(:NOFILE, [4096, hard].min) if soft < 4096
rescue Exception # rubocop:disable Lint/RescueException
  if Gem.win_platform?
    puts "\e[33mWarning: Could not adjust file descriptor limit on Windows. Proceeding with default limits."
    puts "If you faced connection errors or the CLI froze, please report at https://github.com/ieasybooks/tahweel.rb/issues.\e[0m"
  else
    puts "\e[33mWarning: Tahweel failed to increase the soft limit of file descriptors to 4096."
    puts "If you faced connection errors or the CLI froze, try running `ulimit -n 4096` in your terminal."
    puts "If you still face issues, please report them at https://github.com/ieasybooks/tahweel.rb/issues.\e[0m"
  end
end

begin
  options = Tahweel::CLI::Options.parse(ARGV)
  input_path = File.expand_path(ARGV[0])
  files = Tahweel::CLI::FileCollector.collect(input_path, extensions: options[:extensions])

  if files.empty?
    puts "No files found to process."
    exit 0
  end

  Tahweel::Authorizer.authorize if options[:processor] == :google_drive

  base_path = File.directory?(input_path) ? input_path : File.dirname(input_path)

  queue = Queue.new
  files.each { queue << _1 }

  renderer = Tahweel::CLI::ProgressRenderer.new(files.size, options[:file_concurrency])

  Array.new(options[:file_concurrency]) do |i|
    Thread.new do
      until queue.empty?
        begin
          file = queue.pop(true)
        rescue ThreadError
          break
        end

        begin
          renderer.start_file(i, file)

          Tahweel::CLI::FileProcessor.process(file, options.merge(base_input_path: base_path)) do |progress|
            renderer.update(i, progress)
          end

          renderer.finish_file(i)
        rescue StandardError
          renderer.finish_file(i)
        end
      end
    end
  end.each(&:join)

  renderer.finish_all
rescue StandardError => e
  print "\e[?25h"
  abort "Error: #{e.message}"
end
