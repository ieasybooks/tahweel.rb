#!/usr/bin/env ruby

# frozen_string_literal: true

# Add the ../lib directory to the load path so we can require 'tahweel'
$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "tahweel"
require "optparse"

options = {
  dpi: 150,
  processor: :google_drive,
  concurrency: Tahweel::Converter::DEFAULT_CONCURRENCY
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: tahweel <file_path> [options]"

  opts.on("--dpi DPI", Integer, "DPI for PDF to Image conversion (default: 150)") do |d|
    options[:dpi] = d
  end

  opts.on(
    "--processor PROCESSOR", Tahweel::Ocr::AVAILABLE_PROCESSORS,
    "OCR processor to use (default: google_drive). Available: #{Tahweel::Ocr::AVAILABLE_PROCESSORS.join(", ")}"
  ) do |p|
    options[:processor] = p
  end

  opts.on("--concurrency N", Integer, "Max concurrent OCR operations (default: 12)") do |n|
    options[:concurrency] = n
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end

begin
  parser.parse!
rescue OptionParser::InvalidOption => e
  abort "Error: #{e.message}"
end

if ARGV.empty?
  puts parser
  exit 1
end

file_path = ARGV[0]

begin
  if File.extname(file_path).downcase == ".pdf"
    puts "Detected PDF file. Converting to text..."
    texts = Tahweel.convert(
      file_path,
      dpi: options[:dpi],
      processor: options[:processor],
      concurrency: options[:concurrency]
    )

    puts "\n--- Result ---"
    texts.each_with_index do |text, index|
      puts "\n[Page #{index + 1}]"
      puts text
      puts "-" * 20
    end
  else
    puts "Detected image file. Extracting text..."
    puts Tahweel.extract(file_path, processor: options[:processor])
  end
rescue StandardError => e
  abort "Error: #{e.message}"
end
