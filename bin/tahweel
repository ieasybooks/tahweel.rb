#!/usr/bin/env ruby

# frozen_string_literal: true

# Add the ../lib directory to the load path so we can require 'tahweel'
$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "tahweel"

begin
  options = Tahweel::CLI::Options.parse(ARGV)
  input_path = File.expand_path(ARGV[0])
  files = Tahweel::CLI::FileCollector.collect(input_path, extensions: options[:extensions])

  if files.empty?
    puts "No files found to process."
    exit 0
  end

  base_path = File.directory?(input_path) ? input_path : File.dirname(input_path)

  queue = Queue.new
  files.each { queue << _1 }

  workers = Array.new(options[:file_concurrency]) do
    Thread.new do
      until queue.empty?
        begin
          file = queue.pop(true)
        rescue ThreadError
          break
        end

        begin
          Tahweel::CLI::FileProcessor.process(file, options.merge(base_input_path: base_path))
        rescue StandardError => e
          warn "Error processing #{file}: #{e.message}"
        end
      end
    end
  end

  workers.each(&:join)
rescue StandardError => e
  abort "Error: #{e.message}"
end
