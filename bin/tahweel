#!/usr/bin/env ruby

# frozen_string_literal: true

# Add the ../lib directory to the load path so we can require 'tahweel'
$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "tahweel"
require "tahweel/cli/progress_renderer"

begin
  options = Tahweel::CLI::Options.parse(ARGV)
  input_path = File.expand_path(ARGV[0])
  files = Tahweel::CLI::FileCollector.collect(input_path, extensions: options[:extensions])

  if files.empty?
    puts "No files found to process."
    exit 0
  end

  Tahweel::Authorizer.authorize if options[:file_concurrency] > 1 && options[:processor] == :google_drive

  base_path = File.directory?(input_path) ? input_path : File.dirname(input_path)

  queue = Queue.new
  files.each { queue << _1 }

  renderer = Tahweel::CLI::ProgressRenderer.new(files.size, options[:file_concurrency])

  Array.new(options[:file_concurrency]) do |i|
    Thread.new do
      until queue.empty?
        begin
          file = queue.pop(true)
        rescue ThreadError
          break
        end

        begin
          renderer.start_file(i, file)

          Tahweel::CLI::FileProcessor.process(file, options.merge(base_input_path: base_path)) do |progress|
            renderer.update(i, progress)
          end

          renderer.finish_file(i)
        rescue StandardError
          renderer.finish_file(i)
        end
      end
    end
  end.each(&:join)

  renderer.finish_all
rescue StandardError => e
  print "\e[?25h"
  abort "Error: #{e.message}"
end
